version: 2.1

# Puedes habilitar orbs para sonar o node si quieres automatizar a칰n m치s
orbs:
  node: circleci/node@5.0.3

jobs:
  build_and_test:
    docker:
      - image: cimg/node:lts-browsers # Imagen base Node.js
    environment:
      NODE_ENV: production
    steps:
      - checkout

      - run:
          name:  Instalar dependencias
          command: |
            echo "游닍 Instalando dependencias del proyecto..."
            npm install
            echo "丘뙖잺 Instalando Nest CLI globalmente..."
            sudo npm install -g @nestjs/cli

      - run:
          name: Compilar proyecto
          command: npm run build

      - run:
          name: Ejecutar tests unitarios
          command: npm run test

      - run:
          name: An치lisis de c칩digo (ESLint)
          command: |
            echo " Ejecutando ESLint..."
            npm run lint || echo " ESLint encontr칩 errores, pero continuamos..."

      - when:
          condition:
            matches:
              pattern: ".*"
              value: << pipeline.git.branch >>
          steps:
            - run:
                name:  An치lisis de calidad (SonarQube)
                command: |
                  if [ -f sonar-project.properties ]; then
                    echo " Ejecutando an치lisis SonarQube..."
                    npx sonar-scanner \
                      -Dsonar.projectKey=nestd \
                      -Dsonar.sources=src \
                      -Dsonar.host.url=$SONAR_HOST_URL \
                      -Dsonar.login=$SONAR_AUTH_TOKEN
                  else
                    echo " No se encontr칩 archivo sonar-project.properties, omitiendo SonarQube..."
                  fi

  deploy:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name:  Despliegue
          command: |
            echo "Desplegando aplicaci칩n NestJS..."
            npm install pm2 -g
            pm2 delete all || true
            pm2 start dist/main.js --name nestd

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_and_test
      - deploy:
          requires:
            - build_and_test
          filters:
            branches:
              only: main
