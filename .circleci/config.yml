version: 2.1

# Puedes habilitar orbs para sonar o node si quieres automatizar aún más
orbs:
  node: circleci/node@5.0.3

jobs:
  build_and_test:
    docker:
      - image: cimg/node:20.12 # Imagen base Node.js
    environment:
      NODE_ENV: production
    steps:
      - checkout

      - run:
          name:  Instalar dependencias
          command: |
            echo " Instalando dependencias del proyecto..."
            npm install

      - run:
          name: Compilar proyecto
          command: npx nest build

      - run:
          name: Ejecutar tests unitarios
          command: npm run test

      - run:
          name: Análisis de código (ESLint)
          command: |
            echo " Ejecutando ESLint..."
            npm run lint || echo " ESLint encontró errores, pero continuamos..."

      - when:
          condition:
            matches:
              pattern: ".*"
              value: << pipeline.git.branch >>
          steps:
            - run:
                name:  Análisis de calidad (SonarQube)
                command: |
                  if [ -f sonar-project.properties ]; then
                    echo " Ejecutando análisis SonarQube..."
                    npx sonar-scanner \
                      -Dsonar.projectKey=nestd \
                      -Dsonar.sources=src \
                      -Dsonar.host.url=$SONAR_HOST_URL \
                      -Dsonar.login=$SONAR_AUTH_TOKEN
                  else
                    echo " No se encontró archivo sonar-project.properties, omitiendo SonarQube..."
                  fi

  deploy:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout
      - run:
          name:  Despliegue
          command: |
            echo "Desplegando aplicación NestJS..."
            npm install pm2 -g
            pm2 delete all || true
            pm2 start dist/main.js --name nestd

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build_and_test
      - deploy:
          requires:
            - build_and_test
          filters:
            branches:
              only: main
